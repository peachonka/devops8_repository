name: CI/CD with Kind (Kubernetes in Docker)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Install dependencies
      run: npm install
    
    - name: Set up Kind
      run: |
        # Установка Kind
        curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
        chmod +x ./kind
        sudo mv ./kind /usr/local/bin/
        
        # Создание кластера
        kind create cluster --name todo-cluster
        kind get kubeconfig --name todo-cluster > kubeconfig.yaml
    
    - name: Build Docker image
      run: |
        docker build -t todo-app:latest .
        docker tag todo-app:latest todo-app:${{ github.sha }}
    
    - name: Load image into Kind
      run: |
        kind load docker-image --name todo-cluster todo-app:latest
        kind load docker-image --name todo-cluster todo-app:${{ github.sha }}
    
    - name: Set up kubectl
      run: |
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/
        
        # Используем kubeconfig от Kind
        export KUBECONFIG=kubeconfig.yaml
    
    - name: Deploy MongoDB
      run: |
        kubectl apply -f mongo-deployment.yaml
        echo "Waiting for MongoDB..."
        sleep 30
    
    - name: Deploy Todo App
      run: |
        # Создаем ConfigMap
        kubectl apply -f configmap.yaml
        
        # Деплоим приложение
        kubectl apply -f todo-app-deployment.yaml
        
        # Ждем готовности
        kubectl wait --for=condition=available --timeout=120s deployment/todo-app-deployment
    
    - name: Verify deployment
      run: |
        echo "=== Cluster Info ==="
        kubectl cluster-info
        
        echo ""
        echo "=== Pods ==="
        kubectl get pods
        
        echo ""
        echo "=== Services ==="
        kubectl get services
        
        echo ""
        echo "=== Deployments ==="
        kubectl get deployments
    
    - name: Clean up Kind cluster
      if: always()
      run: |
        kind delete cluster --name todo-cluster
